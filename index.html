<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CoAST Interactive – Antimicrobial Activity</title>
<style>
  :root {
    /* Light mode default */
    --bg: #f6f7fb;
    --panel: #ffffff;
    --panel2: #f3f4f6;
    --text: #111827;
    --muted: #4b5563;
    --border: #e5e7eb;
    --accent: #0284c7;
    --theadBg: rgba(255,255,255,0.92);

    --btn-bg: #ffffff;
    --btn-fg: #111827;
    --btn-bg-hover: #f3f4f6;

    --chip-bg: #eef2ff;
    --chip-fg: #3730a3;

    --bad: #dc2626;
    --ok: #f59e0b;
    --good: #16a34a;
    --great: #0ea5e9;

    --shadow: 0 10px 30px rgba(0,0,0,0.08);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --panel2: #111c33;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2a44;
      --accent: #38bdf8;
      --theadBg: rgba(15,23,42,0.92);

      --btn-bg: #0f172a;
      --btn-fg: #e5e7eb;
      --btn-bg-hover: #111c33;

      --chip-bg: rgba(56,189,248,0.12);
      --chip-fg: #7dd3fc;

      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
  }

  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg);
    color: var(--text);
  }

  .container {
    max-width: 1300px;
    margin: 24px auto;
    padding: 0 16px 36px;
  }

  header {
    display:flex;
    gap:16px;
    align-items:flex-start;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 14px;
  }

  .titleblock h1 {
    margin:0;
    font-size: 22px;
    letter-spacing: 0.2px;
  }

  .titleblock p {
    margin: 6px 0 0;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.35;
  }

  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .controls {
    padding: 14px 14px 10px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, var(--panel), var(--panel2));
  }

  .row {
    display:flex;
    gap:12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .row + .row { margin-top: 10px; }

  .field {
    display:flex;
    flex-direction: column;
    gap:6px;
    min-width: 220px;
  }

  label {
    font-size: 12px;
    color: var(--muted);
  }

  input[type="search"], select {
    appearance: none;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 14px;
    background: var(--panel);
    color: var(--text);
    outline: none;
  }

  input[type="search"]:focus, select:focus {
    border-color: rgba(56,189,248,0.6);
    box-shadow: 0 0 0 4px rgba(56,189,248,0.15);
  }

  .btn {
    border: 1px solid var(--border);
    background: var(--btn-bg);
    color: var(--btn-fg);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 13px;
    cursor: pointer;
    display:flex;
    align-items: center;
    gap:8px;
    user-select: none;
  }

  .btn:hover { background: var(--btn-bg-hover); }

  .btn.primary {
    border-color: rgba(56,189,248,0.45);
    background: rgba(56,189,248,0.10);
  }

  .chips {
    display:flex;
    flex-wrap: wrap;
    gap:6px;
  }

  .chip {
    background: var(--chip-bg);
    color: var(--chip-fg);
    border: 1px solid rgba(99,102,241,0.15);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    display:flex;
    align-items:center;
    gap:8px;
  }

  .chip button {
    border:none;
    background: transparent;
    color: inherit;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    padding: 0;
  }

  .meta {
    padding: 10px 14px 12px;
    display:flex;
    justify-content: space-between;
    gap:12px;
    flex-wrap: wrap;
    align-items:center;
    border-bottom: 1px solid var(--border);
    background: var(--panel);
  }

  .meta .note {
    color: var(--muted);
    font-size: 12px;
    line-height: 1.35;
  }

  .legend {
    display:flex;
    gap:10px;
    flex-wrap: wrap;
    align-items:center;
    font-size: 12px;
    color: var(--muted);
  }

  .swatch {
    width: 12px; height: 12px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.08);
  }

  .swatch.bad { background: rgba(220,38,38,0.18); border-color: rgba(220,38,38,0.35); }
  .swatch.ok { background: rgba(245,158,11,0.18); border-color: rgba(245,158,11,0.35); }
  .swatch.good { background: rgba(22,163,74,0.18); border-color: rgba(22,163,74,0.35); }
  .swatch.great { background: rgba(14,165,233,0.18); border-color: rgba(14,165,233,0.35); }
  .swatch.na { background: rgba(148,163,184,0.18); border-color: rgba(148,163,184,0.35); }

  .xscroll {
    border:1px solid var(--border);
    border-radius: 14px;
    overflow-x: auto;
    overflow-y: hidden;
    height: 14px;
    background: var(--panel);
  }
  #topXScroll { margin-bottom: 8px; }
  #topXScrollInner { height: 1px; }

  .tablewrap {
    border:1px solid var(--border);
    border-radius: 14px;
    overflow:auto;
    max-height: 62vh;
    background: white;
  }

  @media (prefers-color-scheme: dark) {
    .tablewrap { background: #0b1220; }
  }

  table {
    border-collapse: separate;
    border-spacing: 0;
    width: max-content;
    min-width: 100%;
    table-layout: fixed;
  }

  thead th {
    position: sticky;
    top: 0;
    background: var(--theadBg);
    backdrop-filter: blur(6px);
    z-index: 6;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    color: var(--muted);
    text-transform: none;
    letter-spacing: 0.1px;
    padding: 10px 10px;
    white-space: nowrap;
    user-select: none;
    cursor: pointer;
  }

  tbody td {
    border-bottom: 1px solid var(--border);
    padding: 9px 10px;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  tbody tr:hover td {
    background: rgba(2,132,199,0.06);
  }

  /* Sticky first columns */
  .sticky-left-th {
    position: sticky;
    left: 0;
    z-index: 8;
    background: var(--theadBg);
  }

  .sticky-left-td {
    position: sticky;
    left: 0;
    z-index: 3;
    background: inherit;
  }

  /* width hints for base columns */
  .col-cat { min-width: 120px; }
  .col-drug { min-width: 170px; }
  .col-class { min-width: 160px; }
  .col-route { min-width: 80px; }

  /* score cells */
  .score {
    font-weight: 600;
    text-align: center;
    border-radius: 10px;
    padding: 6px 8px;
    border: 1px solid transparent;
  }

  .score.bad { color: var(--bad); background: rgba(220,38,38,0.12); border-color: rgba(220,38,38,0.20); }
  .score.ok { color: var(--ok); background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.20); }
  .score.good { color: var(--good); background: rgba(22,163,74,0.12); border-color: rgba(22,163,74,0.20); }
  .score.great { color: var(--great); background: rgba(14,165,233,0.12); border-color: rgba(14,165,233,0.20); }
  .score.na { color: var(--muted); background: rgba(148,163,184,0.12); border-color: rgba(148,163,184,0.20); }

  .footer {
    padding: 12px 14px 14px;
    color: var(--muted);
    font-size: 12px;
    line-height: 1.35;
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    display:none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 1000;
  }
  .modal.open { display:flex; }
  .modal-content {
    width: min(860px, 100%);
    max-height: 80vh;
    overflow:auto;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 14px;
  }
  .modal-header {
    display:flex;
    justify-content: space-between;
    align-items:center;
    gap:10px;
    padding: 6px 6px 10px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 10px;
  }
  .modal-header h2 {
    margin:0;
    font-size: 16px;
  }
  .modal-grid {
    display:grid;
    grid-template-columns: repeat(3, minmax(180px, 1fr));
    gap: 10px;
    padding: 6px;
  }
  @media (max-width: 720px) {
    .modal-grid { grid-template-columns: 1fr; }
  }

  .check {
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding: 10px 10px;
    border: 1px solid var(--border);
    border-radius: 14px;
    background: linear-gradient(180deg, var(--panel), var(--panel2));
  }
  .check input { margin-top: 2px; }
  .check .label {
    display:flex;
    flex-direction: column;
    gap:2px;
  }
  .check .label strong {
    font-size: 13px;
  }
  .check .label span {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.25;
  }

  /* Resizer handle */
  .col-resizer {
    position: absolute;
    top: 0;
    right: -2px;
    width: 6px;
    height: 100%;
    cursor: col-resize;
    user-select: none;
  }
  thead th { position: sticky; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="titleblock">
        <h1>CoAST Interactive Table</h1>
        <p>Filter antimicrobials by spectrum. Click column headers to sort. Drag the column edge to resize.</p>
      </div>
      <div class="row">
        <button class="btn primary" id="organismBtn" type="button">Choose organisms</button>
        <button class="btn" id="resetBtn" type="button">Reset</button>
      </div>
    </header>

    <div class="panel">
      <div class="controls">
        <div class="row">
          <div class="field" style="min-width:260px;">
            <label for="q">Search (drug/class/category)</label>
            <input id="q" type="search" placeholder="e.g., cefepime, carbapenem, anaerobe…" autocomplete="off"/>
          </div>

          <div class="field" style="min-width:200px;">
            <label for="categorySel">Category</label>
            <select id="categorySel">
              <option value="">All categories</option>
            </select>
          </div>

          <div class="field" style="min-width:220px;">
            <label for="routeSel">Route</label>
            <select id="routeSel">
              <option value="">Any route</option>
              <option value="IV">IV</option>
              <option value="PO">PO</option>
              <option value="IV/PO">IV/PO</option>
            </select>
          </div>

          <div class="field" style="min-width:220px;">
            <label for="scoreSel">Spectrum score ≥</label>
            <select id="scoreSel">
              <option value="">No minimum</option>
              <option value="1">≥ 1</option>
              <option value="2">≥ 2</option>
              <option value="3">≥ 3</option>
              <option value="4">≥ 4</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field" style="min-width: 360px; flex: 1;">
            <label>Selected organisms</label>
            <div class="chips" id="selectedChips"></div>
          </div>

          <div class="field" style="min-width: 260px;">
            <label>Optional columns</label>
            <div class="row" style="gap:8px;">
              <label class="btn" style="padding:8px 10px;">
                <input type="checkbox" id="toggleScore" checked style="margin:0 8px 0 0;"/>
                Spectrum score
              </label>
              <label class="btn" style="padding:8px 10px;">
                <input type="checkbox" id="toggleNotes" style="margin:0 8px 0 0;"/>
                Notes
              </label>
            </div>
          </div>

        </div>
      </div>

      <div class="meta">
        <div class="note" id="countNote">Showing 0 agents</div>
        <div class="legend">
          <span style="display:flex; align-items:center; gap:6px;"><span class="swatch great"></span>Strong</span>
          <span style="display:flex; align-items:center; gap:6px;"><span class="swatch good"></span>Good</span>
          <span style="display:flex; align-items:center; gap:6px;"><span class="swatch ok"></span>Limited</span>
          <span style="display:flex; align-items:center; gap:6px;"><span class="swatch bad"></span>Poor</span>
          <span style="display:flex; align-items:center; gap:6px;"><span class="swatch na"></span>N/A</span>
        </div>
      </div>

      <div style="padding: 12px 14px;">
        <div class="xscroll" id="topXScroll" aria-label="Horizontal scroll (top)">
  <div id="topXScrollInner"></div>
</div>
<div class="tablewrap" id="tableWrap">
          <table id="resultsTable">
        <colgroup id="colgroup"></colgroup>
            <thead>
              <tr id="theadRow"></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="footer">
        <strong>Notes:</strong> This is a teaching tool / quick-reference style visualization. It does not replace an antibiogram, guideline, MICs, or clinical judgment.
      </div>
    </div>
  </div>

  <!-- Organism chooser modal -->
  <div class="modal" id="orgModal" role="dialog" aria-modal="true" aria-labelledby="orgTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="orgTitle">Choose organisms to display</h2>
        <div class="row">
          <button class="btn" id="selectCommonBtn" type="button">Common set</button>
          <button class="btn" id="selectAllBtn" type="button">Select all</button>
          <button class="btn" id="clearAllBtn" type="button">Clear</button>
          <button class="btn primary" id="closeModalBtn" type="button">Done</button>
        </div>
      </div>
      <div class="modal-grid" id="orgGrid"></div>
    </div>
  </div>

<script>
(() => {
  // --- Data ------------------------------------------------------------
  // Activity rating per organism (4=strong, 3=good, 2=limited, 1=poor, 0=n/a)
  // You can edit these values to match your course sheet.

  const ORGANISM_META = {
    "MSSA": "Methicillin-susceptible Staphylococcus aureus",
    "MRSA": "Methicillin-resistant Staphylococcus aureus",
    "Strep spp": "β-hemolytic streptococci (A/B/C/G) + viridans (simplified)",
    "Enterococcus faecalis": "E. faecalis (ampicillin-susceptible assumed)",
    "Enterococcus faecium": "E. faecium (VRE risk; simplified)",
    "E. coli": "Escherichia coli",
    "Klebsiella pneumoniae": "Klebsiella pneumoniae",
    "Enterobacter cloacae": "AmpC-risk Enterobacter cloacae complex",
    "Pseudomonas aeruginosa": "P. aeruginosa",
    "Acinetobacter baumannii": "A. baumannii complex",
    "H. influenzae": "Haemophilus influenzae",
    "Moraxella catarrhalis": "Moraxella catarrhalis",
    "Bacteroides fragilis": "Bacteroides fragilis group (anaerobe)",
    "C. difficile": "Clostridioides difficile (for harm/avoid columns if desired)",
    "Atypicals": "Legionella, Mycoplasma, Chlamydia (simplified)"
  };

  const DRUGS = [
    {
      Category: "Penicillins",
      Drug: "Nafcillin / Oxacillin",
      Class: "Anti-staphylococcal penicillin",
      Route: "IV",
      Notes: "MSSA only; no Enterococcus; no Gram-neg coverage.",
      Activity: {
        "MSSA": 4, "MRSA": 0, "Strep spp": 3,
        "Enterococcus faecalis": 0, "Enterococcus faecium": 0,
        "E. coli": 0, "Klebsiella pneumoniae": 0, "Enterobacter cloacae": 0,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 0, "Moraxella catarrhalis": 0,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Penicillins",
      Drug: "Amoxicillin",
      Class: "Aminopenicillin",
      Route: "PO",
      Notes: "No beta-lactamase inhibitor; weak Gram-neg; no Pseudomonas.",
      Activity: {
        "MSSA": 1, "MRSA": 0, "Strep spp": 4,
        "Enterococcus faecalis": 3, "Enterococcus faecium": 1,
        "E. coli": 1, "Klebsiella pneumoniae": 0, "Enterobacter cloacae": 0,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 1, "Moraxella catarrhalis": 0,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Penicillins",
      Drug: "Amoxicillin-clavulanate",
      Class: "Aminopenicillin + BLI",
      Route: "PO",
      Notes: "Adds anaerobes and many beta-lactamase producers; not Pseudomonas.",
      Activity: {
        "MSSA": 3, "MRSA": 0, "Strep spp": 4,
        "Enterococcus faecalis": 3, "Enterococcus faecium": 1,
        "E. coli": 2, "Klebsiella pneumoniae": 2, "Enterobacter cloacae": 1,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 3, "Moraxella catarrhalis": 3,
        "Bacteroides fragilis": 3, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Cephalosporins",
      Drug: "Cefazolin",
      Class: "1st gen cephalosporin",
      Route: "IV",
      Notes: "Good MSSA & strep; limited Gram-neg; no Enterococcus.",
      Activity: {
        "MSSA": 4, "MRSA": 0, "Strep spp": 3,
        "Enterococcus faecalis": 0, "Enterococcus faecium": 0,
        "E. coli": 2, "Klebsiella pneumoniae": 2, "Enterobacter cloacae": 0,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 0, "Moraxella catarrhalis": 0,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Cephalosporins",
      Drug: "Ceftriaxone",
      Class: "3rd gen cephalosporin",
      Route: "IV",
      Notes: "No Pseudomonas; avoid for AmpC-risk organisms when serious infection.",
      Activity: {
        "MSSA": 1, "MRSA": 0, "Strep spp": 4,
        "Enterococcus faecalis": 0, "Enterococcus faecium": 0,
        "E. coli": 4, "Klebsiella pneumoniae": 4, "Enterobacter cloacae": 1,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 4, "Moraxella catarrhalis": 3,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Cephalosporins",
      Drug: "Cefepime",
      Class: "4th gen cephalosporin",
      Route: "IV",
      Notes: "Pseudomonas + many AmpC-risk Enterobacterales; no anaerobes, no Enterococcus.",
      Activity: {
        "MSSA": 2, "MRSA": 0, "Strep spp": 3,
        "Enterococcus faecalis": 0, "Enterococcus faecium": 0,
        "E. coli": 4, "Klebsiella pneumoniae": 4, "Enterobacter cloacae": 4,
        "Pseudomonas aeruginosa": 4, "Acinetobacter baumannii": 2,
        "H. influenzae": 4, "Moraxella catarrhalis": 3,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Carbapenems",
      Drug: "Piperacillin-tazobactam",
      Class: "Ureidopenicillin + BLI",
      Route: "IV",
      Notes: "Broad incl anaerobes + Pseudomonas; not reliable for ESBL.",
      Activity: {
        "MSSA": 2, "MRSA": 0, "Strep spp": 3,
        "Enterococcus faecalis": 2, "Enterococcus faecium": 0,
        "E. coli": 3, "Klebsiella pneumoniae": 3, "Enterobacter cloacae": 3,
        "Pseudomonas aeruginosa": 3, "Acinetobacter baumannii": 1,
        "H. influenzae": 3, "Moraxella catarrhalis": 3,
        "Bacteroides fragilis": 4, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Carbapenems",
      Drug: "Meropenem",
      Class: "Carbapenem",
      Route: "IV",
      Notes: "Very broad incl anaerobes + Pseudomonas; not MRSA/Enterococcus faecium.",
      Activity: {
        "MSSA": 1, "MRSA": 0, "Strep spp": 3,
        "Enterococcus faecalis": 2, "Enterococcus faecium": 0,
        "E. coli": 4, "Klebsiella pneumoniae": 4, "Enterobacter cloacae": 4,
        "Pseudomonas aeruginosa": 4, "Acinetobacter baumannii": 2,
        "H. influenzae": 4, "Moraxella catarrhalis": 3,
        "Bacteroides fragilis": 4, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Glycopeptides",
      Drug: "Vancomycin",
      Class: "Glycopeptide",
      Route: "IV",
      Notes: "Gram+ only. No Gram-neg, no anaerobes, no atypicals.",
      Activity: {
        "MSSA": 3, "MRSA": 4, "Strep spp": 3,
        "Enterococcus faecalis": 2, "Enterococcus faecium": 2,
        "E. coli": 0, "Klebsiella pneumoniae": 0, "Enterobacter cloacae": 0,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 0, "Moraxella catarrhalis": 0,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Oxazolidinones",
      Drug: "Linezolid",
      Class: "Oxazolidinone",
      Route: "IV/PO",
      Notes: "Gram+ incl MRSA/VRE; no Gram-neg.",
      Activity: {
        "MSSA": 3, "MRSA": 4, "Strep spp": 3,
        "Enterococcus faecalis": 3, "Enterococcus faecium": 3,
        "E. coli": 0, "Klebsiella pneumoniae": 0, "Enterobacter cloacae": 0,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 0, "Moraxella catarrhalis": 0,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 0
      }
    },
    {
      Category: "Fluoroquinolones",
      Drug: "Levofloxacin",
      Class: "Fluoroquinolone",
      Route: "IV/PO",
      Notes: "Respiratory FQ; variable Pseudomonas; no anaerobes.",
      Activity: {
        "MSSA": 2, "MRSA": 0, "Strep spp": 2,
        "Enterococcus faecalis": 0, "Enterococcus faecium": 0,
        "E. coli": 3, "Klebsiella pneumoniae": 3, "Enterobacter cloacae": 2,
        "Pseudomonas aeruginosa": 2, "Acinetobacter baumannii": 1,
        "H. influenzae": 4, "Moraxella catarrhalis": 4,
        "Bacteroides fragilis": 0, "C. difficile": 0, "Atypicals": 4
      }
    },
    {
      Category: "Lincosamides",
      Drug: "Clindamycin",
      Class: "Lincosamide",
      Route: "IV/PO",
      Notes: "Gram+ (no Enterococcus) + anaerobes; high CDI risk; no Gram-neg aerobes.",
      Activity: {
        "MSSA": 3, "MRSA": 1, "Strep spp": 3,
        "Enterococcus faecalis": 0, "Enterococcus faecium": 0,
        "E. coli": 0, "Klebsiella pneumoniae": 0, "Enterobacter cloacae": 0,
        "Pseudomonas aeruginosa": 0, "Acinetobacter baumannii": 0,
        "H. influenzae": 0, "Moraxella catarrhalis": 0,
        "Bacteroides fragilis": 3, "C. difficile": 0, "Atypicals": 0
      }
    }
  ];

  const ALL_ORGANISMS = Object.keys(ORGANISM_META);

  const BASE_COLS = ["Category","Drug","Class","Route"];
  const OPTIONAL_COLS = ["Spectrum score","Notes"];

  const commonSet = ["MSSA","MRSA","Strep spp","E. coli","Klebsiella pneumoniae","Enterobacter cloacae","Pseudomonas aeruginosa","Bacteroides fragilis","Atypicals"];

  // --- DOM refs --------------------------------------------------------
  const q = document.getElementById("q");
  const categorySel = document.getElementById("categorySel");
  const routeSel = document.getElementById("routeSel");
  const scoreSel = document.getElementById("scoreSel");
  const selectedChips = document.getElementById("selectedChips");
  const countNote = document.getElementById("countNote");
  const theadRow = document.getElementById("theadRow");
  const tbody = document.getElementById("tbody");
  const tableWrap = document.getElementById("tableWrap");
  const topXScroll = document.getElementById("topXScroll");
  const topXScrollInner = document.getElementById("topXScrollInner");
  const colgroup = document.getElementById("colgroup");

  const COL_WIDTHS_STORAGE_KEY = "coast_colWidths_v1";
  let colWidths = (() => {
    try { return JSON.parse(localStorage.getItem(COL_WIDTHS_STORAGE_KEY) || "{}") || {}; }
    catch { return {}; }
  })();
  let _saveColWidthsTimer = null;
  function scheduleSaveColWidths() {
    clearTimeout(_saveColWidthsTimer);
    _saveColWidthsTimer = setTimeout(() => {
      try { localStorage.setItem(COL_WIDTHS_STORAGE_KEY, JSON.stringify(colWidths)); } catch {}
    }, 150);
  }
  function defaultColWidth(key) {
    const k = (key || "").toLowerCase();
    if (k === "category") return 140;
    if (k === "drug") return 190;
    if (k === "class") return 170;
    if (k === "route") return 90;
    if (k.includes("spectrum")) return 140;
    return 140;
  }
  function getColWidth(key, fallbackPx) {
    const w = colWidths[key];
    if (Number.isFinite(w) && w > 30) return w;
    if (Number.isFinite(fallbackPx) && fallbackPx > 30) return fallbackPx;
    return defaultColWidth(key);
  }

  let _syncingXScroll = false;
  function syncXScrollSize() {
    const table = document.getElementById("resultsTable");
    if (!table || !topXScroll || !topXScrollInner || !tableWrap) return;
    const scrollW = table.scrollWidth;
    topXScrollInner.style.width = scrollW + "px";
    const needs = scrollW > tableWrap.clientWidth + 1;
    topXScroll.style.display = needs ? "block" : "none";
  }
  function initXScrollSync() {
    if (!tableWrap || !topXScroll) return;
    tableWrap.addEventListener("scroll", () => {
      if (_syncingXScroll) return;
      _syncingXScroll = true;
      topXScroll.scrollLeft = tableWrap.scrollLeft;
      _syncingXScroll = false;
    });
    topXScroll.addEventListener("scroll", () => {
      if (_syncingXScroll) return;
      _syncingXScroll = true;
      tableWrap.scrollLeft = topXScroll.scrollLeft;
      _syncingXScroll = false;
    });
    window.addEventListener("resize", () => { syncXScrollSize(); });
  }

  const organismBtn = document.getElementById("organismBtn");
  const resetBtn = document.getElementById("resetBtn");
  const toggleScore = document.getElementById("toggleScore");
  const toggleNotes = document.getElementById("toggleNotes");

  const orgModal = document.getElementById("orgModal");
  const orgGrid = document.getElementById("orgGrid");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const selectCommonBtn = document.getElementById("selectCommonBtn");
  const selectAllBtn = document.getElementById("selectAllBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");

  // --- State -----------------------------------------------------------
  let selectedOrganisms = [...commonSet];
  let showScore = true;
  let showNotes = false;
  let sortKey = "Spectrum score";
  let sortDir = "desc";

  // --- Helpers ---------------------------------------------------------
  function scoreToClass(v) {
    if (v === 4) return "great";
    if (v === 3) return "good";
    if (v === 2) return "ok";
    if (v === 1) return "bad";
    return "na";
  }

  function calcSpectrumScore(drug) {
    // average over selected organisms (ignoring N/A)
    const vals = selectedOrganisms.map(o => drug.Activity[o] ?? 0).filter(v => v > 0);
    if (!vals.length) return 0;
    const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
    return Math.round(avg * 10) / 10;
  }

  function getVisibleData() {
    const query = q.value.trim().toLowerCase();
    const cat = categorySel.value;
    const route = routeSel.value;
    const minScore = scoreSel.value ? parseFloat(scoreSel.value) : null;

    let rows = DRUGS.map(d => ({
      ...d,
      "Spectrum score": calcSpectrumScore(d)
    }));

    if (query) {
      rows = rows.filter(d =>
        d.Drug.toLowerCase().includes(query) ||
        d.Class.toLowerCase().includes(query) ||
        d.Category.toLowerCase().includes(query)
      );
    }
    if (cat) rows = rows.filter(d => d.Category === cat);
    if (route) rows = rows.filter(d => d.Route === route);

    if (minScore !== null) rows = rows.filter(d => (d["Spectrum score"] || 0) >= minScore);

    // sort
    rows.sort((a,b) => {
      const k = sortKey;
      const dir = sortDir === "asc" ? 1 : -1;
      let av = a[k] ?? "";
      let bv = b[k] ?? "";
      if (typeof av === "string") av = av.toLowerCase();
      if (typeof bv === "string") bv = bv.toLowerCase();
      if (av < bv) return -1*dir;
      if (av > bv) return 1*dir;
      return 0;
    });

    return rows;
  }

  function renderCategoryOptions() {
    const cats = [...new Set(DRUGS.map(d => d.Category))].sort();
    const current = categorySel.value;
    categorySel.innerHTML = `<option value="">All categories</option>` + cats.map(c => `<option>${c}</option>`).join("");
    categorySel.value = current;
  }

  function renderSelectedChips() {
    selectedChips.innerHTML = "";
    if (!selectedOrganisms.length) {
      selectedChips.innerHTML = `<span class="note" style="color:var(--muted); font-size:12px;">None selected (table will show base columns only).</span>`;
      return;
    }
    selectedOrganisms.forEach(o => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerHTML = `<span>${o}</span><button title="Remove">×</button>`;
      chip.querySelector("button").addEventListener("click", () => {
        selectedOrganisms = selectedOrganisms.filter(x => x !== o);
        renderSelectedChips();
        applyFilters();
        // keep modal in sync if open
        const cb = orgGrid.querySelector(`input[data-org="${cssEscape(o)}"]`);
        if (cb) cb.checked = false;
      });
      selectedChips.appendChild(chip);
    });
  }

  function cssEscape(s) {
    return s.replace(/"/g,'\\"');
  }

  // Sticky columns helper
  function applyStickyColumns() {
    const table = document.getElementById("resultsTable");
    const ths = Array.from(table.querySelectorAll("thead th"));
    const tdsRows = Array.from(table.querySelectorAll("tbody tr"));

    const stickyCount = BASE_COLS.length; // first columns always sticky
    let left = 0;

    for (let i = 0; i < stickyCount; i++) {
      const th = ths[i];
      if (!th) continue;
      th.classList.add("sticky-left-th");
      th.style.left = left + "px";

      // add classes for width hints
      if (i === 0) th.classList.add("col-cat");
      if (i === 1) th.classList.add("col-drug");
      if (i === 2) th.classList.add("col-class");
      if (i === 3) th.classList.add("col-route");

      const w = th.offsetWidth;
      // body cells
      tdsRows.forEach(tr => {
        const td = tr.children[i];
        if (td) {
          td.classList.add("sticky-left-td");
          td.style.left = left + "px";
        }
      });
      left += w;
    }
  }

  function makeColumnsResizable(cols) {
    // Uses <colgroup> widths so resizing is reliable and survives re-render.
    const table = document.getElementById("resultsTable");
    if (!table) return;

    const ths = Array.from(table.querySelectorAll("thead th"));
    const colEls = Array.from(colgroup.querySelectorAll("col"));

    // If cols not passed, derive keys from header dataset/text.
    const keys = (cols && cols.length) ? cols.slice() : ths.map(th => th.dataset.colKey || th.textContent || "");

    ths.forEach((th, idx) => {
      if (th.querySelector(".col-resizer")) return;

      const key = keys[idx] || th.dataset.colKey || th.textContent || "";
      th.dataset.colKey = key;

      const initW = getColWidth(key, th.getBoundingClientRect().width);
      if (colEls[idx]) colEls[idx].style.width = initW + "px";
      th.style.width = initW + "px";

      const resizer = document.createElement("div");
      resizer.className = "col-resizer";
      th.appendChild(resizer);

      let startX = 0;
      let startW = 0;

      const onMove = (e) => {
        const dx = e.clientX - startX;
        const newW = Math.max(60, Math.min(700, startW + dx));
        colWidths[key] = newW;
        if (colEls[idx]) colEls[idx].style.width = newW + "px";
        th.style.width = newW + "px";
        applyStickyColumns();
        syncXScrollSize();
        scheduleSaveColWidths();
      };

      const onUp = () => {
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
        document.body.style.cursor = "";
      };

      resizer.addEventListener("mousedown", (e) => {
        e.preventDefault();
        e.stopPropagation();
        startX = e.clientX;
        startW = th.getBoundingClientRect().width;
        document.body.style.cursor = "col-resize";
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
    });
  }

  function renderTable() {
    const rows = getVisibleData();

    // decide which columns to show
    const cols = BASE_COLS.concat(
      (showScore ? ["Spectrum score"] : []),
      (showNotes ? ["Notes"] : []),
      selectedOrganisms
    );

    // col widths (via <colgroup>) so resize + sticky offsets are stable
    colgroup.innerHTML = "";
    cols.forEach((c) => {
      const colEl = document.createElement("col");
      colEl.dataset.colKey = c;
      colEl.style.width = getColWidth(c) + "px";
      colgroup.appendChild(colEl);
    });

    // header
    theadRow.innerHTML = "";
    cols.forEach((c) => {
      const th = document.createElement("th");
      th.textContent = c;
      th.dataset.colKey = c;
      th.style.width = getColWidth(c) + "px";
      th.title = "Click to sort";
      if (c === sortKey) th.textContent = `${c} ${sortDir === "asc" ? "▲" : "▼"}`;

      th.addEventListener("click", () => {
        if (sortKey === c) {
          sortDir = (sortDir === "asc") ? "desc" : "asc";
        } else {
          sortKey = c;
          sortDir = (c === "Spectrum score") ? "desc" : "asc";
        }
        renderTable();
      });

      theadRow.appendChild(th);
    });

    // body
    tbody.innerHTML = "";
    rows.forEach(d => {
      const tr = document.createElement("tr");
      cols.forEach(c => {
        const td = document.createElement("td");
        if (c === "Spectrum score") {
          const v = d["Spectrum score"] || 0;
          const cls = scoreToClass(Math.round(v));
          td.innerHTML = `<div class="score ${cls}">${v ? v.toFixed(1) : "—"}</div>`;
        } else if (c === "Notes") {
          td.textContent = d.Notes || "";
          td.style.maxWidth = "360px";
        } else if (BASE_COLS.includes(c)) {
          td.textContent = d[c] || "";
        } else {
          const v = d.Activity[c] ?? 0;
          const cls = scoreToClass(v);
          const label = v === 0 ? "—" : (v === 4 ? "Strong" : v === 3 ? "Good" : v === 2 ? "Limited" : "Poor");
          td.innerHTML = `<div class="score ${cls}">${label}</div>`;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    countNote.textContent = `Showing ${rows.length} agent${rows.length === 1 ? "" : "s"}`;

    // re-apply sticky positioning after render (needs layout)
    setTimeout(() => { applyStickyColumns(); makeColumnsResizable(cols); syncXScrollSize(); }, 0);
  }

  function applyFilters() {
    renderSelectedChips();
    renderTable();
  }

  // --- Organism modal --------------------------------------------------
  function renderOrganismOptions() {
    orgGrid.innerHTML = "";
    ALL_ORGANISMS.forEach(o => {
      const wrap = document.createElement("label");
      wrap.className = "check";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedOrganisms.includes(o);
      cb.dataset.org = o;

      const label = document.createElement("div");
      label.className = "label";
      label.innerHTML = `<strong>${o}</strong><span>${ORGANISM_META[o]}</span>`;

      cb.addEventListener("change", () => {
        if (cb.checked) {
          if (!selectedOrganisms.includes(o)) selectedOrganisms.push(o);
        } else {
          selectedOrganisms = selectedOrganisms.filter(x => x !== o);
        }
      });

      wrap.appendChild(cb);
      wrap.appendChild(label);
      orgGrid.appendChild(wrap);
    });
  }

  function openModal() {
    renderOrganismOptions();
    orgModal.classList.add("open");
  }
  function closeModal() {
    // commit selection, keep stable order based on ALL_ORGANISMS
    const selected = Array.from(orgGrid.querySelectorAll("input[type=checkbox]"))
      .filter(cb => cb.checked)
      .map(cb => cb.dataset.org);
    selectedOrganisms = ALL_ORGANISMS.filter(o => selected.includes(o));
    orgModal.classList.remove("open");
    applyFilters();
  }

  // --- Events ----------------------------------------------------------
  [q, categorySel, routeSel, scoreSel].forEach(el => el.addEventListener("input", applyFilters));
  categorySel.addEventListener("change", applyFilters);
  routeSel.addEventListener("change", applyFilters);
  scoreSel.addEventListener("change", applyFilters);

  toggleScore.addEventListener("change", () => { showScore = toggleScore.checked; applyFilters(); });
  toggleNotes.addEventListener("change", () => { showNotes = toggleNotes.checked; applyFilters(); });

  organismBtn.addEventListener("click", openModal);
  closeModalBtn.addEventListener("click", closeModal);
  orgModal.addEventListener("click", (e) => { if (e.target === orgModal) closeModal(); });

  selectCommonBtn.addEventListener("click", () => {
    Array.from(orgGrid.querySelectorAll("input[type=checkbox]")).forEach(cb => {
      cb.checked = commonSet.includes(cb.dataset.org);
    });
  });
  selectAllBtn.addEventListener("click", () => {
    Array.from(orgGrid.querySelectorAll("input[type=checkbox]")).forEach(cb => cb.checked = true);
  });
  clearAllBtn.addEventListener("click", () => {
    Array.from(orgGrid.querySelectorAll("input[type=checkbox]")).forEach(cb => cb.checked = false);
  });

  resetBtn.addEventListener("click", () => {
    q.value = "";
    categorySel.value = "";
    routeSel.value = "";
    scoreSel.value = "";
    selectedOrganisms = [...commonSet];
    showScore = true;
    showNotes = false;
    toggleScore.checked = true;
    toggleNotes.checked = false;
    sortKey = "Spectrum score";
    sortDir = "desc";
    applyFilters();
  });

  // init
  initXScrollSync();
  renderCategoryOptions();
  renderSelectedChips();
  applyFilters();
})();
</script>
</body>
</html>
